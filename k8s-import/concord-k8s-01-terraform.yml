configuration:

  arguments:
    # --------------------------------------------------------------------------------------------------------------------
    # Defaults
    # --------------------------------------------------------------------------------------------------------------------
    terraformDebug: false
    terraformVersion: 0.12.18
    terraformDirectory: "terraform"
    terraformResources: "terraform-resources"
    terraformResourcesTag: "1.0.0"

flows:

  # --------------------------------------------------------------------------------------------------------------------
  # Terraform
  # --------------------------------------------------------------------------------------------------------------------
  # TODO: the terraform processor is general purpose but the configuration below needs to be decoupled from AWS.
  # --------------------------------------------------------------------------------------------------------------------

  terraform:
    - terraformProcessor
    - terraformExecution

  terraformProcessor:

    - task: git
      in:
        action: clone
        url: "https://github.com/jvanzyl/concord-terraform.git"
        baseBranch: "${terraformResourcesTag}"
        workingDir: "${terraformResources}"

    - task: terraformProcessor
      in:
        resourceDirectory: "${terraformResources}"
        outputDirectory: "${terraformDirectory}"
        configuration:
          version: "0.12"
          provider: "${clusterRequest.provider}"
          authentication: credentials
          configuration:
            aws_region: "${clusterRequest.region}"
            aws_access_key: "${clusterRequest.aws.accessKey}"
            aws_secret_key: "${clusterRequest.aws.secretKey}"
            tags: ${clusterRequest.aws.tags}
          resources: ${clusterRequest.terraformResources}

  terraformExecution:

    - task: terraform
      in:
        toolVersion: "${terraformVersion}"
        action: apply
        dir: "${terraformDirectory}"
        saveOutput: true
        stateId: ${clusterRequest.clusterId}
        varFiles:
          - "${workDir}/${terraformDirectory}/00.auto.tfvars.json"
